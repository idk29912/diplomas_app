{% extends "layout.html" %}
{% block title %}Consultar Diploma · Sistema de Diplomas{% endblock %}
{% block content %}

<!-- Hero Section de Consulta -->
<section class="hero-section text-center mb-5 fade-in">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="hero-content">
        <!-- Icono principal -->
        <div class="hero-icon mb-4">
          <div class="d-inline-flex align-items-center justify-content-center position-relative"
               style="width: 100px; height: 100px; background: var(--gradient-success); border-radius: 50%;">
            <i class="fas fa-search text-white" style="font-size: 2.5rem;"></i>
          </div>
        </div>

        <h1 class="display-5 fw-bold text-dark mb-3">
          Consultar mi <span class="text-gradient-success">Diploma</span>
        </h1>
        
        <p class="lead text-muted mb-4">
          Ingresa tu CURP para consultar y descargar tu constancia de capacitación en computación.
        </p>
      </div>
    </div>
  </div>
</section>

<!-- Formulario de búsqueda -->
<section class="lookup-section mb-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-6">
      <div class="card border-0 shadow-lg">
        <div class="card-body p-4 p-md-5">
          <form method="post" id="lookupForm">
            <div class="mb-4">
              <label for="curp" class="form-label fw-semibold">
                <i class="fas fa-id-card me-2 text-primary"></i>
                CURP (Clave Única de Registro de Población)
              </label>
              <input 
                type="text" 
                class="form-control form-control-lg" 
                id="curp" 
                name="curp" 
                placeholder="Ej: ABCD123456HEFGHIJ01"
                maxlength="18"
                value="{{ request.form.get('curp', '') }}"
                required
                style="text-transform: uppercase;"
              >
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                El CURP debe tener exactamente 18 caracteres
              </div>
            </div>
            
            <div class="d-grid">
              <button type="submit" class="btn btn-success btn-lg hover-lift">
                <i class="fas fa-search me-2"></i>
                Buscar Diploma
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Resultados de la búsqueda -->
{% if diploma %}
<section class="results-section mb-5 fade-in">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-10">
      <div class="card border-0 shadow-lg border-success" style="border-width: 3px !important;">
        <div class="card-header bg-success text-white p-4">
          <div class="d-flex align-items-center">
            <div class="me-3">
              <i class="fas fa-certificate" style="font-size: 2rem;"></i>
            </div>
            <div>
              <h4 class="mb-1">✅ Diploma Encontrado</h4>
              <p class="mb-0 opacity-75">Documento válido y verificado</p>
            </div>
          </div>
        </div>
        
        <div class="card-body p-4">
          <!-- Información del estudiante -->
          <div class="row g-4 mb-4">
            <div class="col-12 col-md-6">
              <div class="info-card h-100">
                <div class="info-header mb-2">
                  <i class="fas fa-user text-primary me-2"></i>
                  <span class="fw-semibold">Información del Estudiante</span>
                </div>
                <div class="info-content">
                  <div class="mb-2">
                    <strong>Nombre:</strong> {{ diploma.nombre }}
                  </div>
                  <div class="mb-2">
                    <strong>CURP:</strong> {{ diploma.curp }}
                  </div>
                  <div class="mb-2">
                    <strong>Grado:</strong> {{ diploma.grado }}
                  </div>
                  <div>
                    <strong>Grupo:</strong> {{ diploma.grupo }}
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-12 col-md-6">
              <div class="info-card h-100">
                <div class="info-header mb-2">
                  <i class="fas fa-graduation-cap text-info me-2"></i>
                  <span class="fw-semibold">Información del Curso</span>
                </div>
                <div class="info-content">
                  <div class="mb-2">
                    <strong>Curso:</strong> {{ curso.nombre }}
                  </div>
                  <div class="mb-2">
                    <strong>Nivel:</strong> {{ curso.nivel }}
                  </div>
                  <div class="mb-2">
                    <strong>Duración:</strong> {{ curso.horas }} horas académicas
                  </div>
                  <div>
                    <strong>Fecha:</strong> {{ diploma.fecha.strftime('%d de %B, %Y') if diploma.fecha else 'No especificada' }}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Información de la escuela -->
          <div class="row g-4 mb-4">
            <div class="col-12">
              <div class="info-card">
                <div class="info-header mb-2">
                  <i class="fas fa-school text-warning me-2"></i>
                  <span class="fw-semibold">Información de la Institución</span>
                </div>
                <div class="info-content">
                  <div class="row">
                    <div class="col-md-6 mb-2">
                      <strong>Escuela:</strong> {{ escuela.nombre }}
                    </div>
                    <div class="col-md-3 mb-2">
                      <strong>CCT:</strong> {{ escuela.cct }}
                    </div>
                    <div class="col-md-3 mb-2">
                      <strong>Turno:</strong> {{ escuela.turno or 'No especificado' }}
                    </div>
                    {% if escuela.director %}
                    <div class="col-md-6 mb-2">
                      <strong>Director(a):</strong> {{ escuela.director }}
                    </div>
                    {% endif %}
                    {% if escuela.coordinador %}
                    <div class="col-md-6 mb-2">
                      <strong>Coordinador(a):</strong> {{ escuela.coordinador }}
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Competencias y módulos -->
          {% if curso.competencias or curso.modulos %}
          <div class="row g-4 mb-4">
            {% if curso.competencias %}
            <div class="col-12 col-lg-6">
              <div class="info-card h-100">
                <div class="info-header mb-2">
                  <i class="fas fa-list-check text-success me-2"></i>
                  <span class="fw-semibold">Competencias Desarrolladas</span>
                </div>
                <div class="info-content">
                  <p class="mb-0">{{ curso.competencias }}</p>
                </div>
              </div>
            </div>
            {% endif %}
            
            {% if curso.modulos %}
            <div class="col-12 col-lg-6">
              <div class="info-card h-100">
                <div class="info-header mb-2">
                  <i class="fas fa-puzzle-piece text-purple me-2"></i>
                  <span class="fw-semibold">Módulos del Curso</span>
                </div>
                <div class="info-content">
                  <p class="mb-0">{{ curso.modulos }}</p>
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}

          <!-- Acciones -->
          <div class="d-flex flex-column flex-md-row gap-3 justify-content-center pt-3">
            <a href="/cert/{{ diploma.id }}" 
               class="btn btn-primary btn-lg hover-lift" 
               target="_blank">
              <i class="fas fa-file-pdf me-2"></i>
              Descargar PDF
            </a>
            
            <button class="btn btn-info btn-lg hover-lift" onclick="showQRModal()">
              <i class="fas fa-qrcode me-2"></i>
              Ver Código QR
            </button>
            
            <button class="btn btn-outline-secondary btn-lg hover-lift" onclick="shareResult()">
              <i class="fas fa-share-alt me-2"></i>
              Compartir
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Modal QR Code -->
<div class="modal fade" id="qrModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-qrcode me-2"></i>
          Código QR de Verificación
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <div class="mb-3">
          <div id="qrcode" class="d-inline-block p-3 bg-white border rounded"></div>
        </div>
        <p class="text-muted">
          Escanea este código QR para verificar la autenticidad del diploma
        </p>
        <div class="alert alert-info">
          <small>
            <strong>URL de verificación:</strong><br>
            <code>{{ request.url_root }}verify/{{ diploma.id }}</code>
          </small>
        </div>
      </div>
    </div>
  </div>
</div>

{% elif request.method == 'POST' %}
<!-- Resultado negativo -->
<section class="results-section mb-5 fade-in">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card border-0 shadow-lg border-danger" style="border-width: 3px !important;">
        <div class="card-body p-4 p-md-5 text-center">
          <div class="mb-4">
            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
          </div>
          <h4 class="text-danger mb-3">❌ Diploma No Encontrado</h4>
          <p class="text-muted mb-4">
            No se encontró ningún diploma asociado al CURP: 
            <strong>{{ request.form.get('curp', '') }}</strong>
          </p>
          <div class="alert alert-warning">
            <h6 class="alert-heading">Posibles razones:</h6>
            <ul class="mb-0 text-start">
              <li>El CURP ingresado es incorrecto</li>
              <li>El diploma aún no ha sido registrado en el sistema</li>
              <li>No has completado ningún curso de computación</li>
            </ul>
          </div>
          <div class="d-flex gap-2 justify-content-center">
            <button onclick="window.location.reload()" class="btn btn-primary">
              <i class="fas fa-redo me-2"></i>
              Intentar Nuevamente
            </button>
            <a href="/" class="btn btn-outline-secondary">
              <i class="fas fa-home me-2"></i>
              Volver al Inicio
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
{% endif %}

<!-- Información adicional -->
<section class="info-section mb-5">
  <div class="row justify-content-center">
    <div class="col-12 col-lg-8">
      <div class="card bg-light border-0">
        <div class="card-body p-4">
          <h5 class="mb-3">
            <i class="fas fa-info-circle text-info me-2"></i>
            Información Importante
          </h5>
          <div class="row g-3">
            <div class="col-md-6">
              <div class="d-flex">
                <i class="fas fa-shield-alt text-success me-2 mt-1"></i>
                <div>
                  <strong>Documentos Oficiales</strong>
                  <p class="small text-muted mb-0">Todos los diplomas son documentos oficialmente válidos</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <i class="fas fa-clock text-warning me-2 mt-1"></i>
                <div>
                  <strong>Disponibilidad 24/7</strong>
                  <p class="small text-muted mb-0">Accede a tu diploma en cualquier momento</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <i class="fas fa-lock text-primary me-2 mt-1"></i>
                <div>
                  <strong>Datos Seguros</strong>
                  <p class="small text-muted mb-0">Tu información está protegida y encriptada</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="d-flex">
                <i class="fas fa-phone text-info me-2 mt-1"></i>
                <div>
                  <strong>Soporte Técnico</strong>
                  <p class="small text-muted mb-0">¿Problemas? Contacta al administrador</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
// Validación de CURP en tiempo real
document.getElementById('curp').addEventListener('input', function(e) {
    const curp = e.target.value.toUpperCase();
    e.target.value = curp;
    
    // Validación básica de formato CURP
    const curpPattern = /^[A-Z]{4}[0-9]{6}[HM][A-Z]{5}[0-9A-Z][0-9]$/;
    
    if (curp.length === 18) {
        if (curpPattern.test(curp)) {
            e.target.classList.remove('is-invalid');
            e.target.classList.add('is-valid');
        } else {
            e.target.classList.remove('is-valid');
            e.target.classList.add('is-invalid');
        }
    } else {
        e.target.classList.remove('is-valid', 'is-invalid');
    }
});

// Función para mostrar modal QR
function showQRModal() {
    {% if diploma %}
    const modal = new bootstrap.Modal(document.getElementById('qrModal'));
    
    // Limpiar QR anterior
    document.getElementById('qrcode').innerHTML = '';
    
    // Generar nuevo QR (necesitas incluir una librería QR como qrious o qrcode.js)
    const qr = new QRCode(document.getElementById('qrcode'), {
        text: '{{ request.url_root }}verify/{{ diploma.id }}',
        width: 200,
        height: 200,
        colorDark: '#000000',
        colorLight: '#ffffff',
    });
    
    modal.show();
    {% endif %}
}

// Función para compartir resultado
function shareResult() {
    {% if diploma %}
    if (navigator.share) {
        navigator.share({
            title: 'Mi Diploma de Computación',
            text: 'He completado exitosamente el curso: {{ curso.nombre }}',
            url: window.location.href
        });
    } else {
        // Fallback para navegadores que no soportan Web Share API
        const url = window.location.href;
        navigator.clipboard.writeText(url).then(() => {
            alert('Enlace copiado al portapapeles');
        });
    }
    {% endif %}
}

// Animaciones al cargar
document.addEventListener('DOMContentLoaded', function() {
    // Hacer scroll suave al resultado si existe
    {% if diploma or request.method == 'POST' %}
    document.querySelector('.results-section').scrollIntoView({ 
        behavior: 'smooth',
        block: 'start'
    });
    {% endif %}
});
</script>

{% endblock %}